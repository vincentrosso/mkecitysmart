Development notes for mkecitysmart
---------------------------------------

Change log (most recent first)
- 2026-01-31 [F-104] Tow Helper: Created TowHelperScreen with Recovery Guide (5-step process) and Tow Lots directory; Milwaukee tow lot data with phone/address/hours; quick-dial phone integration; Google/Apple Maps directions; fee estimator; tips to avoid future tows; dashboard tile.
- 2026-01-31 [F-103] Saved Places: SavedPlace model + SavedPlacesService with Firestore persistence, local caching, geohash encoding; SavedPlacesScreen with home/work cards, favorites list, place editor sheet; per-place notification radius; linked from Profile screen.
- 2026-01-31 [F-403] Analytics Instrumentation: Added firebase_analytics + firebase_crashlytics; AnalyticsService with screen/event/error tracking; FlutterError.onError and PlatformDispatcher.onError handlers; user ID binding; tracking in FeedScreen, SavedPlacesScreen, TowHelperScreen.
- 2026-01-31 [F-402] Performance: Enabled Firestore persistence (100MB cache); CacheService with LRU eviction, TTL, namespaced storage; geohash-based querying in FeedFilterService.
- 2026-01-31 [F-006] Sightings feed filters: Created FeedFilterService for scalable query building; FeedScreen with filter bar UI (radius: 1mi/5mi/10mi/city-wide; time: 1hr/2hr/6hr/24hr/all); haversine distance filtering from user position; Firestore time window queries; pagination with Load More (20/page); improved card UI with relative time and distance display.
- 2026-01-31 [F-108] User profile display: Updated CitySmartScaffold and MainDrawer with signed-in user info; avatar+name in app bar with PopupMenu (Profile/Preferences/Sign Out); drawer header with user details and sign-out confirmation dialog.
- 2026-01-31 [F-107] Ticket Tracker: Built TicketTrackerScreen with tab-based UI (Open/Paid/Add New); ImagePicker photo capture; manual entry form; payment tracking with late fee calculations; dashboard tile and route.
- 2026-01-31 [F-106] Parking Finder: Created ParkingFinderScreen with FlutterMap; 10 Milwaukee parking locations (garages/lots/street); color-coded markers (Blue=Garage, Green=Lot, Yellow=Street); tap for details with Google Maps directions.
- 2026-01-31 [F-105] User onboarding: 5-page flow (Welcome, Avoid Tickets, Alt-Side, Notifications, Create Account); OnboardingService with SharedPreferences; integrated into main.dart routing; CitySmart brand styling.
- 2026-01-31 [F-405] Garbage Day fix: Fixed URL case sensitivity in GarbageScheduleService; Milwaukee DPW API changed `DPWServletsPublic` → `DpwServletsPublic`; was causing HTTP 302 redirects.
- 2026-01-31 [F-203] EV charging map: Simplified for mobile; collapsible filter panel; FlutterMap with OpenChargeMap; connector filters (CCS/CHAdeMO/J1772/Tesla); color-coded markers by power; tap-to-expand station details.
- 2026-01-31 [F-102] Smart notifications complete: Added sendHighRiskAlerts Cloud Function for citation-based risk alerts; integrated with parking risk heatmap system.
- 2026-01-31 [F-101] Parking risk heatmap: Processed 466K Milwaukee citations into 44 geohash risk zones (Firestore citation_risk_zones); Cloud Functions (getRiskForLocation, getRiskZones, sendHighRiskAlerts); ParkingRiskService + ParkingRiskBadge; FlutterMap heatmap with color-coded risk levels (green/yellow/orange/red).
- 2026-01-31 [F-404] TestFlight build: New archive with onboarding, parking finder, ticket tracker, EV map improvements, user profile display, parking risk heatmap; ready for App Store Connect upload.
- 2026-01-18 [F-102] Push notification infrastructure completed (FCM tokens, APNs forwarding, sendNearbyAlerts callable); emulator testing with rate limits/audit logs; ready for production activation.
- 2026-01-17/18 [F-008] Moderation baseline implemented; report button increments reports; 4+ reports exclude from feed; per-anonymous UID rate limiting; verified locally.
- 2026-01-16 [F-404] Production build uploaded to App Store Connect; internal TestFlight enabled; full core loop verified on real iOS devices (submit → appear → expire → disappear).
- 2026-01-15/16 [F-007] Expiration engine active via cleanupExpiredSightings; sightings auto-expire and disappear from live feed; verified with Dretzka Park test doc (~8 PM).
- 2026-01-15/16 [F-003] Permanent app-to-backend connectivity: anonymous auth; submissions create sightings/alerts with mirroring; verified via iOS simulator, curl, and Cloud Functions logs.
- 2026-01-15 [EMULATORS] Wired debug-only emulators for Functions/Firestore/Auth in main bootstrap; TODO: add Storage emulator wiring (FirebaseStorage.useStorageEmulator).
- 2026-01-15 [EMULATORS] Storage emulator note: FirebaseStorage.instance.useStorageEmulator('localhost', 9199).
- 2026-01-15/16 [F-404] Release build uploaded to App Store Connect; TestFlight internal testing enabled and functioning; iOS build confirmed production-ready.
- 2026-01-15 [F-007] Expiration system verified: test doc flipped to status="expired"; cleanupExpiredSightings runs on schedule; no manual intervention required.
- 2026-01-15 [F-003] Permanent app-to-backend connectivity confirmed: end-to-end app→backend→Firestore→mirror chain; sightings created; functions mirror to alerts/global; anonymous auth and rate limits verified; no crashes or silent failures.
- 2026-01-14 [F-003] App-to-backend connectivity confirmed via iOS simulator submission; sightings write succeeded with mirroring; test doc "Dwayne Jan 14th Test Feed" at Dretzka Park, expires ~8 PM (temp open rules used).
- 2026-01-14 [F-002] Inventory Cloud Functions (prod) - clean deploy confirmed with logs.
  Status: DONE
  Goal: Full visibility into deployed functions in production (project: mkeparkapp-1ad15), with confirmation of clean deploys, consistent configs (region: us-central1, runtime: nodejs20, memory: 256MiB), and no errors in audit/runtime logs. This answers "What backend actually exists right now?" and verifies stability for the P0 chain.
  Inventory Summary: 6 deployed 2nd gen Cloud Functions (via gcloud functions describe --gen2):
    - cleanupExpiredSightings (Scheduled trigger; expiration system)
    - helloWorld (HTTPS trigger; test endpoint)
    - mirrorSightingsToAlerts (Firestore write on sightings/{sightingId})
    - mirrorUserSightingsToGlobal (Firestore create on users/{uid}/sightings/{sightingId})
    - notifyOnApproval (Firestore update on alerts/{alertId})
    - submitSighting (Callable HTTPS trigger; core submission endpoint)
  Config Checks: All functions consistent (us-central1, nodejs20, 256MiB); triggers align with app needs (submission, mirroring for feeds/alerts, scheduled cleanup).
  Log Verification: Deployment audits successful (e.g., 2026-01-14T18:52:19Z for submitSighting); runtime errors none (severity>=ERROR empty); cleanupExpiredSightings runs ~every 5 min (HTTP 200 OK, ~0.1–1.0s latency); submitSighting has no invocations yet.
  Commands Used: gcloud functions describe --gen2; gcloud logging read (resource.type=cloud_run_revision, service_name, severity>=ERROR).
  Recommendations: Add targeted console.log statements (e.g., "Expired X sightings") for faster debugging; backend appears stable.
- 2026-01-11 [F-005] Verified sightings can be created and persist in Firestore; manual docs showed feed invisibility comes from path/schema mismatch; data layer is sound when written to correct collections.
- 2026-01-10 [F-001] Confirmed MKE City Smart is using the correct Firebase project (Blaze plan). Ruled out environment mismatch as cause of missing alerts/sightings. Removed “wrong project” as a failure vector in backend debugging.
- 2026-01-11 [F-004] Defined and validated the production Firestore schema. Locked core collections (sightings, live_sightings, alerts) and required fields. Confirmed that writing to incorrect paths explains “missing” feed data. Schema is now the single source of truth for app + backend.
- 2026-01-14 [F-401] Updated alerts rules for public reads + admin deletes; added firestore.indexes.json reference; deployed rules + indexes.

- Flutter version: uses Flutter 3.29.x locally; run `flutter --version` if needed.
- Platforms: iOS, Android, Web; web uses `web/firebase-config.json` and Dart config in `lib/firebase_options.dart`.
- Firebase: Config in `lib/firebase_options.dart` (web/android/ios). Web also has `web/firebase-config.json`. Register authorized domains for web in Firebase Auth.
- Auth flows:
  * Email/password: handled in `lib/screens/auth_screen.dart` via `UserProvider.register/login`.
  * Phone, Google, Apple: see `UserProvider` methods and `_handlePhoneSignUp`, `_handleGoogle`, `_handleApple` in auth screen.
  * Guest mode supported.
- Profile:
  * Profile page (`lib/screens/profile_screen.dart`) now geocodes addresses via `geocoding` and saves raw + formatted address + lat/lng in `UserProfile`.
  * `UserProfile` JSON fields: `formattedAddress`, `addressLatitude`, `addressLongitude` added.
- Linting:
  * `flutter analyze` currently clean. Deprecated `withOpacity`, `describeEnum`, and `desiredAccuracy` already replaced.
  * Welcome dialog and quick-start tutorial are disabled via flags in `lib/main.dart`. Promo banner on dashboard is commented out.
- CI sanity check:
  * Run `flutter analyze` after changes (fast lint/error pass; no device/emulator required).
- Web embeds:
  * `openchargemap_embed_web.dart` and `publicstuff_embed_web.dart` use `package:web` instead of `dart:html`. Dependency `web` is added to pubspec.
- Scripts:
  * `scripts/test_firebase_auth.py` to hit Firebase Identity Toolkit REST (sign-up/sign-in). Reads web API key from env `FIREBASE_WEB_API_KEY` or falls back to `lib/firebase_options.dart` web key.
- Pods / iOS:
  * CocoaPods repo updated and pods installed with Firebase iOS SDK 12.4.0. Warning about base configuration is benign with custom xcconfigs.
- Feature toggles:
  * Welcome dialog: `CitySmartShell._welcomeDialogEnabled` (currently false).
  * Quick start tutorial: `_quickStartEnabled` false; helper widgets removed.
  * Promo banner disabled in `lib/screens/dashboard_screen.dart`.
- Addressing:
  * When updating profile address, failures in geocoding block the save with a snackbar.
- Debugging:
  * VS Code launch config in `.vscode/launch.json` includes Flutter web (Chrome).
- Navigation chrome:
  * Shared `CitySmartScaffold` (drawer + CitySmart title + bottom nav) in `lib/widgets/citysmart_scaffold.dart`.
  * Applied to landing, dashboard, feed, profile, auth, vehicles, and charging map screens; bottom nav routes to `/dashboard`, `/citysmart-map`, `/citysmart-feed`.
- Branding:
  * User-facing brand text updated to “MKE CitySmart” across app bars, welcome, splash, and auth copy.
  * iOS/macOS app icons updated from `assets/MKE_AppIcon.appiconset.zip` into:
    - `ios/Runner/Assets.xcassets/AppIcon.appiconset/`
    - `macos/Runner/Assets.xcassets/AppIcon.appiconset/` (currently uses the same set; replace with macOS-specific sizes if provided).
  * Web manifest renamed to "MKE CitySmart" with updated icons (`web/icons/Icon-192.png`, `Icon-512.png`, maskable variants) and favicon regenerated from the 1024px master.

New Features (2026-01-31)
- Onboarding:
  * 5-page first-time user experience in `lib/screens/onboarding_screen.dart`
  * Pages: Welcome, Avoid Tickets, Alt-Side Parking, Notifications, Create Account
  * OnboardingService (`lib/services/onboarding_service.dart`) tracks completion via SharedPreferences
  * Auto-routes first-time users; skips for returning users
- Parking Risk Heatmap:
  * Citation data: 466K Milwaukee parking citations processed into 44 geohash risk zones
  * Firestore collection: `citation_risk_zones` with geohash, riskScore, citationCount, topViolations, coordinates
  * Cloud Functions: `getRiskForLocation`, `getRiskZones`, `sendHighRiskAlerts` (us-central1, nodejs20)
  * Flutter: `ParkingRiskService` (`lib/services/parking_risk_service.dart`), `ParkingRiskBadge` widget
  * Heatmap screen: `lib/screens/parking_heatmap_screen.dart` with FlutterMap + color-coded risk polygons
- Parking Finder:
  * `lib/screens/parking_finder_screen.dart` - interactive map with 10 Milwaukee parking locations
  * Color-coded markers: Blue (Garage), Green (Lot), Yellow (Street)
  * Tap markers for details; "Get Directions" launches Google Maps
  * Route: `/parking-finder`, dashboard tile added
- Ticket Tracker:
  * `lib/screens/ticket_tracker_screen.dart` - photo capture and ticket tracking
  * Tab-based UI: Open tickets, Paid tickets, Add New
  * ImagePicker for photo capture; manual entry form with violation type, amount, due date
  * Payment tracking with late fee calculations ($25 after 14 days)
  * Route: `/ticket-tracker`, dashboard tile added
- EV Charging Map:
  * Simplified `lib/screens/charging_map_screen.dart` for mobile
  * Collapsible filter panel with connector types (CCS, CHAdeMO, J1772, Tesla)
  * FlutterMap with OpenChargeMap integration
  * Color-coded markers by power level; tap-to-expand station details
- User Profile Display:
  * `CitySmartScaffold` updated with user avatar + name in app bar when signed in
  * PopupMenuButton with Profile, Preferences, Sign Out options
  * `MainDrawer` header shows avatar, name, email with Sign Out option
  * Sign-out confirmation dialog prevents accidental logout
- Saved Places (F-103):
  * `lib/models/saved_place.dart` - SavedPlace model with Firestore/JSON serialization, geohash support
  * `lib/services/saved_places_service.dart` - Firestore persistence, local caching, real-time sync
  * `lib/screens/saved_places_screen.dart` - Home/work cards, favorites list, place editor sheet
  * Per-place notification radius settings (0.1 to 2.0 miles)
  * One home/work location, up to 50 favorites per user
  * Linked from Profile screen; initialized in app bootstrap
- Tow Helper (F-104):
  * `lib/screens/tow_helper_screen.dart` - Vehicle recovery guidance
  * Recovery Guide tab: 5-step process with phone/map actions
  * Tow Lots tab: Milwaukee tow lot directory with contacts
  * Quick-dial phone integration, Google/Apple Maps directions
  * Fee estimator with tow/storage/admin breakdown
  * Tips to avoid future tows
- Performance + Analytics (F-402/F-403):
  * Firestore persistence enabled (100MB cache) for offline-first
  * `lib/services/cache_service.dart` - LRU eviction, TTL, namespaced storage
  * `lib/services/analytics_service.dart` - Firebase Analytics + Crashlytics wrapper
  * Automatic crash reporting via FlutterError.onError, PlatformDispatcher.onError
  * Event tracking in FeedScreen, SavedPlacesScreen, TowHelperScreen

Open items / reminders:
- If re-enabling welcome or quick-start, restore content in `main.dart`.
- If you rotate Firebase keys, update both `lib/firebase_options.dart` and `web/firebase-config.json`.
- For web iframe embeds, ensure `web` dependency stays in sync and authorized domains are set.
- After any code changes, run `flutter analyze` to ensure code quality.
- The project should maintain at least 80% unit test coverage.

App layout (current)
- Shell: `CitySmartScaffold` (drawer + title + bottom nav + user profile) wraps all main screens.
- Routes: `/dashboard` (default home), `/citysmart-feed`, `/citysmart-map`, `/profile`, `/auth/login`, `/auth/register`, `/vehicles`, `/charging-map`, `/parking-heatmap`, `/parking-finder`, `/ticket-tracker`, `/onboarding`, `/saved-places`, `/tow-helper`.
- Drawer: dashboard, map, feed, profile, parking finder, ticket tracker, tow helper, saved places; user info in header with sign-out.
- Dashboard tiles include alerts, permits, tickets, street sweeping, vehicles, EV chargers, alt side parking, parking finder, ticket tracker, parking risk heatmap, tow helper, saved places.
- Quick start, welcome banner, and promo banner are disabled via flags in `lib/main.dart` / `dashboard_screen.dart`.

Coverage and size snapshot (after latest tests)
- Overall: 26.44% (1703/6440 lines) from `coverage/lcov.info`.
- Coverage by segment: screens 4.6% (128/2813), services 75.2% (574/763), widgets 16.7% (26/156), models 84.1% (391/465), providers 25.6% (188/733), data 26.7% (356/1331), citysmart 15.3% (13/85).
- LOC by segment (Dart): screens 7,739; services 2,000; widgets 525; models 1,142; providers 1,836; data 3,079; citysmart 611.

Architecture flow (text diagram)
- UI (screens/widgets) ⇄ Providers (ChangeNotifier, e.g., UserProvider)
    Providers depend on UserRepository + services for async work and local hydration.
- UserRepository
    ⇄ Firebase Auth (session)
    ⇄ Firestore (users + subcollections)
    ⇄ Drift Local DB (profiles, vehicles, pending mutations)
    → Outbox sync: enqueue on Firestore failure → syncPending retries when online.
- Services
    - ApiClient (POST with env base URL/API key) → Prediction/Notification/token registration.
    - RiskAlertService (timer, tow/ticket scoring) → LocationService + CityTicketStatsService + TicketRiskPredictionService → NotificationService (local/FCM).
    - NotificationService (FCM/local) guarded for web/disabled flag.
    - StreetSegmentService (ArcGIS), TicketApiService (mock), PredictionApiService (HTTP).
    - LocationService (Geolocator, sample zones, distance/directions).
- Firebase bootstrap
    - firebase_bootstrap + firebase_options (platform configs), web also uses web/firebase-config.json.
