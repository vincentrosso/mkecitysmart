rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // === Public city alerts/feed ===
    // - Anyone can read (signed in or not)
    // - Authenticated users can create/update (with anti-spam timestamp check)
    // - Only admins (via custom claim) can delete
    match /alerts/{alertId} {
      allow read: if true;  // Public reads

      allow create: if request.auth != null  // Must be signed in
                    && request.resource.data.timestamp == request.time;  // Anti-spam: timestamp must match server time

      allow update: if request.auth != null
                    && request.resource.data.timestamp == request.time;  // Optional: re-validate timestamp on update

      allow delete: if request.auth != null
                    && request.auth.token.admin == true;  // Admin-only deletes
    }

    // === Example: User profiles (private) ===
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // === Example: User reports/sightings ===
    match /reports/{reportId} {
      allow read: if true;
      allow create: if request.auth != null
                    && request.resource.data.timestamp == request.time
                    && request.resource.data.reporterId == request.auth.uid;
      allow update, delete: if request.auth != null
                           && resource.data.reporterId == request.auth.uid;
    }

    // Catch-all: Deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
