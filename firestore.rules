rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Public alerts/feed â€” anyone can read, writes are restricted to the
    // backend or authenticated users creating limited fields.
    match /alerts/{alertId} {
      allow read: if true;

      // Clients may create only a minimal subset; they must NOT set approval/status fields.
      // In practice, the app submits via callable functions, but keep rules safe anyway.
      allow create: if request.auth != null
        && request.resource.data.keys().hasOnly([
          'title',
          'message',
          'location',
          'type',
          'timestamp',
          'createdAt',
          'source',
          'reporterUid',
          'isPublic',
          'geo'
        ])
        && request.resource.data.reporterUid == request.auth.uid;

      // Only admins/moderators can update/delete alerts.
      allow update, delete: if request.auth != null &&
        (request.auth.token.admin == true || request.auth.token.moderator == true);
    }

    // Sightings (user reports). Public reads allowed; reporters subcollection
    // prevents duplicate reports and limits who can write reporter records.
    match /sightings/{sightingId} {
      allow read: if true;

      // Creation allowed for authenticated users with a minimal set of fields.
      allow create: if request.auth != null
        && request.resource.data.timestamp == request.time
        && request.resource.data.keys().hasAny(['type','location','timestamp','reportCount']);

      // Allow updates only to the numeric reportCount field (prevents abuse)
      allow update: if request.auth != null
        && request.resource.data.keys().hasOnly(['reportCount'])
        && request.resource.data.reportCount is int;

      match /reporters/{reporterId} {
        // A user can create a reporter doc for themselves to indicate they've reported.
        allow create: if request.auth != null && request.auth.uid == reporterId;
        // Allow read for authenticated users so moderators can inspect reporters.
        allow read: if request.auth != null;
        // Prevent deletes/updates from clients; only backend/admins may remove reporter records.
        allow update, delete: if request.auth != null && request.auth.token.admin == true;
      }
    }

    // User profiles: only the owner can read/write their profile
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Users subcollections (e.g., /users/{uid}/sightings) are only writable by the owner
      match /{subcol=**} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Device registry for nearby-alert fanout.
    // Clients can upsert their own device doc with a constrained schema.
    match /devices/{deviceId} {
      allow read: if request.auth != null;

      // Create/update limited to the authenticated user that owns the uid field.
      allow create, update: if request.auth != null
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.token is string
        && request.resource.data.platform is string
        && request.resource.data.radiusMiles is number
        && request.resource.data.keys().hasOnly([
          'uid',
          'token',
          'platform',
          'location',
          'geohash',
          'locationPrecisionMeters',
          'radiusMiles',
          'createdAt',
          'updatedAt',
          'lastSeenAt'
        ]);

      // Delete allowed by owner; backend/admins can also delete.
      allow delete: if request.auth != null
        && (resource.data.uid == request.auth.uid || request.auth.token.admin == true);
    }

    // Saved places (home, work, favorites) - user-owned data
    match /savedPlaces/{placeId} {
      // Users can read only their own saved places
      allow read: if request.auth != null
        && resource.data.userId == request.auth.uid;

      // Users can create saved places for themselves
      allow create: if request.auth != null
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasAll(['userId', 'name', 'type', 'latitude', 'longitude']);

      // Users can update/delete only their own saved places
      allow update, delete: if request.auth != null
        && resource.data.userId == request.auth.uid;
    }

    // Citation risk zones - read-only for app users (populated by backend)
    match /citation_risk_zones/{zoneId} {
      allow read: if true;
      allow write: if false;
    }

    // App logs - allow authenticated users to write logs for debugging/analytics
    match /appLogs/{logId} {
      allow create: if request.auth != null;
      allow read, update, delete: if false;
    }

    // Deny everything else by default.
    match /{document=**} {
      allow read: if false;
      allow write: if false;
    }
  }
}
