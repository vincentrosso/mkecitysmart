#!/bin/bash

# CitySmart Parking App - Pre-commit Hook
# Prevents commits that would cause deployment issues

set -e

echo "ðŸ” Running pre-commit checks..."

# Check if we're in a Flutter project
if [ ! -f "pubspec.yaml" ]; then
    echo "âŒ Not a Flutter project. Skipping pre-commit checks."
    exit 0
fi

# Function for colored output
print_error() {
    echo -e "\033[0;31m[ERROR]\033[0m $1"
}

print_success() {
    echo -e "\033[0;32m[SUCCESS]\033[0m $1"
}

print_warning() {
    echo -e "\033[1;33m[WARNING]\033[0m $1"
}

# Get list of changed Dart files
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.dart$' || true)

if [ -z "$CHANGED_FILES" ]; then
    echo "â„¹ï¸  No Dart files changed. Skipping checks."
    exit 0
fi

echo "ðŸ“ Checking ${CHANGED_FILES}"

# Check 1: Prevent Navigator.pushNamed usage
echo "ðŸ§­ Checking navigation patterns..."
if echo "$CHANGED_FILES" | xargs grep -l "Navigator\.pushNamed" 2>/dev/null; then
    print_error "Found Navigator.pushNamed usage in staged files!"
    print_error "Please use GoRouter context.go() or context.push() instead."
    echo ""
    echo "Example fixes:"
    echo "  âŒ Navigator.pushNamed(context, '/route')"
    echo "  âœ… context.go('/route')"
    echo "  âœ… context.push('/route')"
    exit 1
fi
print_success "Navigation patterns OK"

# Check 2: Prevent hardcoded font families (except in theme files)
echo "ðŸ”¤ Checking font usage..."
FONT_VIOLATIONS=$(echo "$CHANGED_FILES" | grep -v "theme\.dart" | xargs grep -l "fontFamily:" 2>/dev/null || true)
if [ -n "$FONT_VIOLATIONS" ]; then
    print_warning "Found hardcoded fontFamily usage outside theme files:"
    echo "$FONT_VIOLATIONS"
    print_warning "Consider using theme-based font definitions instead."
fi

# Check 3: Prevent setState during build
echo "ðŸ—ï¸  Checking for setState during build..."
if echo "$CHANGED_FILES" | xargs grep -l "setState.*initState\|setState.*build" 2>/dev/null; then
    print_error "Found potential setState during build!"
    print_error "Use WidgetsBinding.instance.addPostFrameCallback() for initialization."
    exit 1
fi
print_success "Build patterns OK"

# Check 4: Format check
echo "âœ¨ Checking code formatting..."
if ! dart format --set-exit-if-changed $CHANGED_FILES; then
    print_error "Code is not properly formatted!"
    echo "Run: dart format ."
    exit 1
fi
print_success "Code formatting OK"

# Check 5: Basic analysis on changed files
echo "ðŸ” Running analysis on changed files..."
for file in $CHANGED_FILES; do
    if ! flutter analyze --no-preamble "$file" 2>/dev/null; then
        print_error "Analysis issues found in $file"
        echo "Run: flutter analyze"
        exit 1
    fi
done
print_success "Analysis OK"

# Check 6: Prevent debug/test code in commits
echo "ðŸš« Checking for debug code..."
DEBUG_PATTERNS="print\(|debugPrint\(|console\.log\(|TODO:|FIXME:|XXX:"
if echo "$CHANGED_FILES" | xargs grep -n -E "$DEBUG_PATTERNS" 2>/dev/null; then
    print_warning "Found potential debug code in staged files."
    print_warning "Consider removing debug prints and TODO comments before committing."
fi

echo ""
print_success "ðŸŽ‰ All pre-commit checks passed!"
echo "âœ… Safe to commit"