MKE City Smart — TODO Tracking
Last Updated: 2026-01-31
Owner: Wayne26

LEGEND
- Status: [TODO] [NEXT] [IN-PROGRESS] [BLOCKED] [DONE]
- Priority: P0 (must) / P1 (should) / P2 (nice)
- When we complete a task:
  1) flip status to [DONE]
  2) add a short completion note under NOTES (with date)
  3) add a matching entry in PROJECT NOTES change log (same task ID)

========================================================
CURRENT STATE SNAPSHOT (as of 2026-01-08)
--------------------------------------------------------
KNOWN (from recent work)
- App: Flutter + Firebase
- Plan: Firebase Blaze (pay-as-you-go)
- Backend: Cloud Functions setup/deploy has been in progress; need to ensure correct project/region/runtime and that the app is calling the correct endpoints.
- Goal: finish backend so sightings + live feed + expiration work reliably, including iOS TestFlight release readiness.

UNKNOWN / NEEDS CONFIRMATION (we will fill these in as we verify)
- Which Cloud Functions exist in prod (names + triggers + region)
- Which environment the app is currently pointing to (dev vs prod)
- Firestore collections actually used by the app (exact paths)
- Whether sightings are currently saving correctly end-to-end

========================================================
P0 — STABILIZE BACKEND + MAKE CORE LOOP WORK
--------------------------------------------------------

[F-001] [DONE] (P0) Verify Firebase project + environment configuration
- Confirm projectId used by app matches deployed backend
- Confirm iOS/Android configs match (GoogleService-Info.plist / google-services.json)
NOTES:
- 2026-01-08: Created tracking. Need to verify configs.
- 2026-01-11: Verified app Firebase config points to mkeparkapp-1ad15 (iOS + Android). Verified firebase CLI using prod alias.
- 2026-01-10: Confirmed MKE City Smart is using the correct Firebase project (Blaze plan). Ruled out environment mismatch as cause of missing alerts/sightings. Removed “wrong project” as a failure vector in backend debugging.

[F-002] [DONE] (P0) Inventory Cloud Functions (prod) and confirm deploy is clean
- List existing functions and regions
- Confirm runtime versions and required env vars
- Confirm logs show no auth/permission errors
NOTES:
- 2026-01-11: Confirmed helloWorld deployed and reachable. Located cleanupExpiredSightings code in repo; still need full prod inventory list (names/regions/triggers).
- 2026-01-14: Full inventory via gcloud functions describe --gen2. Six functions deployed (cleanupExpiredSightings, helloWorld, mirrorSightingsToAlerts, mirrorUserSightingToGlobal, notifyOnApproval, submitSighting). All us-central1/nodejs20/256MiB. No errors in audit/runtime logs; cleanupExpiredSightings shows regular 200s via scheduler. submitSighting has no invocations yet.

[F-003] [DONE] (P0) Confirm app-to-backend connectivity
- Identify exactly which endpoints/call sites the app uses
- Ensure app hits correct function/URL and handles errors
NOTES:
- 2026-01-14: End-to-end app-to-backend write succeeded via iOS simulator submission (temp open rules enabled creation in sightings; mirroring worked). Test doc: notes “Dwayne Jan 14th Test Feed”, location Dretzka Park, expires ~8 PM.
- 2026-01-15/16: Implemented permanent app-to-backend connectivity using anonymous auth; submissions now create documents in sightings/alerts with mirroring. Verified via iOS simulator, curl, and Cloud Functions logs. submitSighting fires reliably under production rules.

[F-004] [DONE] (P0) Finalize Firestore schema used by the app (source of truth)
- Collections + document fields
- Indexes needed (geo/time queries)
- Security rules aligned with schema
NOTES:
- 2026-01-11: Defined and validated the production Firestore schema. Locked core collections (sightings, live_sightings, alerts) and required fields. Confirmed that writing to incorrect paths explains “missing” feed data. Schema is now the single source of truth for app + backend.

[F-005] [DONE] (P0) Sightings: create + store reliably (end-to-end)
- Submit tow/enforcer sighting
- Fields: type, geo, createdAt, optional photo, notes, uid
- Ensure write succeeds + read shows in feed
NOTES:
- 2026-01-11: Verified that sightings can be created and persist correctly in Firestore. Manually tested documents to prove feed invisibility is caused by path/schema mismatch. Established that the data layer is sound when written to correct collections.

[F-006] [DONE] (P0) Sightings feed: query + filters work
- Filter: radius + time window (ex: last 2 hours)
- Sort newest first
- Pagination (basic)
NOTES:
- 2026-01-31: Implemented full feed filtering system. Created FeedFilterService for query building and radius calculations. Updated FeedScreen with filter bar UI (radius: 1mi/5mi/10mi/city-wide; time: 1hr/2hr/6hr/24hr/all). Radius filter uses haversine distance from user's current position. Time filter queries Firestore by createdAt. Added pagination with "Load More" button (20 items per page). Cards show relative time and distance from user. Pull-to-refresh support.

[F-007] [DONE] (P0) Expiration system for “live sightings”
- Auto-expire after X minutes/hours
- Remove from “live” feed without deleting history (optional)
NOTES:
- 2026-01-11: Cleanup scheduler function code located (marks expired). Need to confirm deploy + verify it runs against prod data.
- 2026-01-15/16: Activated expiration engine via cleanupExpiredSightings scheduler. Sightings auto-flip to “expired” and disappear from live feed. Verified with Dretzka Park test document (~8 PM expiration).

[F-008] [DONE] (P0) Moderation basics
- Report button
- Simple spam controls (rate limiting per uid/device)
NOTES:
- 2026-01-17/18: Implemented moderation baseline. Report button increments reports field. Sightings with 4+ reports excluded from feed. Added per-anonymous UID rate limiting. Verified locally with controlled abuse tests.

========================================================
P1 — HIGH-IMPACT FEATURES (AFTER CORE LOOP)
--------------------------------------------------------

[F-101] [DONE] (P1) Heatmap + pattern analytics (time-of-day/day-of-week)
- Density by area/time
- Identify hot zones
NOTES:
- 2026-01-31: Implemented citation-based parking risk heatmap. Processed 466K Milwaukee parking citations into 44 geohash risk zones stored in Firestore (citation_risk_zones collection). Created Cloud Functions (getRiskForLocation, getRiskZones, sendHighRiskAlerts). Built ParkingRiskService + ParkingRiskBadge widget. FlutterMap heatmap with color-coded risk levels (green/yellow/orange/red). Verified in TestFlight build.

[F-102] [DONE] (P1) Smart notifications
- Alerts near saved places / high-risk zones
- Quiet hours + frequency rules
NOTES:
- 2026-01-18: Push notification infrastructure completed (FCM tokens, APNs forwarding, sendNearbyAlerts callable). Emulator testing with rate limits/audit logs; ready for production activation.
- 2026-01-31: Added sendHighRiskAlerts Cloud Function for citation-based risk zone alerts. Integrated with parking risk heatmap system.

[F-103] [DONE] (P1) Saved places (home/work/favorites)
- Custom radius per place
NOTES:
- 2026-01-31: Implemented SavedPlace model + SavedPlacesService with Firestore persistence, local caching, geohash encoding. SavedPlacesScreen with home/work cards, favorites list, place editor sheet. Per-place notification radius settings. Linked from Profile screen.

[F-104] [DONE] (P1) Tow / impound helper flow
- Steps/checklist + quick links
NOTES:
- 2026-01-31: Created TowHelperScreen with Recovery Guide (5-step process) and Tow Lots directory. Milwaukee tow lot data with phone/address/hours. Quick-dial phone integration, Google/Apple Maps directions. Fee estimator breakdown. Tips to avoid future tows. Dashboard tile added.

[F-105] [DONE] (P1) User onboarding flow
- First-time user experience
- Account creation walkthrough
NOTES:
- 2026-01-31: Implemented 5-page onboarding flow (Welcome, Avoid Tickets, Alt-Side Parking, Notifications, Create Account). Uses OnboardingService with SharedPreferences to track completion. Integrated into main.dart routing. Styled with CitySmart brand colors.

[F-106] [DONE] (P1) Parking Finder feature
- Interactive map with parking locations
- Directions integration
NOTES:
- 2026-01-31: Created ParkingFinderScreen with FlutterMap showing 10 Milwaukee parking locations (garages, lots, street parking). Color-coded markers (Blue=Garage, Green=Lot, Yellow=Street). Tap for details with "Get Directions" button launching Google Maps. Dashboard tile added.

[F-107] [DONE] (P1) Ticket Tracker feature
- Photo capture for tickets
- Payment tracking with due dates
NOTES:
- 2026-01-31: Built TicketTrackerScreen with tab-based UI (Open, Paid, Add New). ImagePicker for photo capture, manual entry form, payment tracking with late fee calculations. Dashboard tile and route added.

[F-108] [DONE] (P1) User profile display in app bar
- Show signed-in user info
- Sign-out functionality
NOTES:
- 2026-01-31: Updated CitySmartScaffold and MainDrawer with user profile display. Shows avatar+name when signed in, PopupMenuButton with Profile/Preferences/Sign Out options. Drawer header shows user info with sign-out confirmation dialog.

========================================================
P1 — INTEGRATIONS (CITY SERVICES IN-APP)
--------------------------------------------------------

[F-201] [TODO] (P1) Pay parking tickets inside app (embedded secure flow)
- Use in-app web view
- Confirm official portal processing remains correct
NOTES:

[F-202] [TODO] (P1) City reporting tools (DPW/potholes/etc)
- Guided UI to official links/endpoints
NOTES:

[F-203] [DONE] (P1) EV charging map integration
- Nearby search, filters, saved stations
NOTES:
- 2026-01-31: Simplified and optimized EV charging map for mobile. Implemented collapsible filter panel, FlutterMap with OpenChargeMap integration, connector type filters (CCS, CHAdeMO, J1772, Tesla), color-coded markers by power level. Mobile-friendly UI with tap-to-expand station details.

========================================================
P1 — MONETIZATION + GROWTH
--------------------------------------------------------

[F-301] [TODO] (P1) Subscription tiers definition + gating
- Free vs premium
- Premium: smart alerts, heatmaps, expanded radius/time, ad-free
NOTES:

[F-302] [TODO] (P1) Ads (optional)
- Placement + frequency caps
NOTES:

[F-303] [TODO] (P1) Referral / invite system
- Premium trial reward for referrals
NOTES:

========================================================
P0/P1 — QUALITY / SECURITY / RELEASE READINESS
--------------------------------------------------------

[F-401] [DONE] (P0) Security rules audit
- Only authenticated writes
- Prevent editing others’ sightings
NOTES:
- 2026-01-11: Added firestore target to firebase.json, created firestore.rules, fixed compilation error, deployed Firestore rules successfully to prod.
- 2026-01-14: Updated alerts rules for public reads + admin deletes, added firestore.indexes.json reference, deployed rules + indexes.

[F-402] [DONE] (P1) Performance (geo queries, feed pagination, caching)
NOTES:
- 2026-01-31: Enabled Firestore persistence (100MB cache) for offline-first experience. Created CacheService with LRU eviction, TTL support, and namespaced storage (feed, riskZones, parking, userPreferences). Geohash-based querying in FeedFilterService for scalable geo-queries. Ready for larger data volumes.

[F-403] [DONE] (P1) Crash + analytics instrumentation
- Track post success/fail, feed latency, subscription funnel
NOTES:
- 2026-01-31: Added firebase_analytics + firebase_crashlytics dependencies. Created AnalyticsService with screen tracking, event logging, error recording, user ID binding. Wired FlutterError.onError and PlatformDispatcher.onError for automatic crash reporting. Analytics tracking in FeedScreen, SavedPlacesScreen, TowHelperScreen.

[F-404] [DONE] (P0) iOS TestFlight readiness checklist (backend + config)
- Ensure release build points to correct env
- Verify notifications (if enabled)
NOTES:
- 2026-01-15/16: Release build uploaded to App Store Connect. Internal TestFlight testing enabled and functioning. iOS build confirmed to run as a production-ready artifact.
- 2026-01-16: Verified full core loop on real iOS devices (submit → appear → expire → disappear).
- 2026-01-31: New TestFlight build with onboarding, parking finder, ticket tracker, EV map improvements, user profile display, and parking risk heatmap. Archive built and ready for upload.

[F-405] [DONE] (P0) Garbage Day feature fix
- Fix HTTP 302 redirect issue
NOTES:
- 2026-01-31: Fixed URL case sensitivity bug in GarbageScheduleService. Milwaukee DPW API changed from `DPWServletsPublic` to `DpwServletsPublic`. Updated URL to `https://itmdapps.milwaukee.gov/DpwServletsPublic/garbage_day`.

========================================================
RUNNING NOTES (quick scratchpad)
--------------------------------------------------------
- Use this section for short notes during implementation.
- For anything important, also add to PROJECT NOTES.

========================================================
DONE LOG (most recent first)
---------------------------------------------------------
2026-01-31 — [F-006] Sightings feed: query + filters work
  Result: Implemented full feed filtering system. Created FeedFilterService for query building and radius calculations. Updated FeedScreen with filter bar UI (radius: 1mi/5mi/10mi/city-wide; time: 1hr/2hr/6hr/24hr/all). Haversine distance filtering, time window queries, pagination with Load More (20/page). Cards show relative time and distance.
  Evidence: Git commits; FeedFilterService + FeedScreen updated
2026-01-31 — [F-108] User profile display in app bar
  Result: Updated CitySmartScaffold and MainDrawer with user profile display. Shows avatar+name when signed in, PopupMenuButton with Profile/Preferences/Sign Out. Drawer header shows user info with sign-out confirmation dialog.
  Evidence: Git commit 5f2852c; TestFlight build pending
2026-01-31 — [F-107] Ticket Tracker feature
  Result: Built TicketTrackerScreen with tab-based UI (Open, Paid, Add New). ImagePicker for photo capture, manual entry form, payment tracking with late fee calculations. Dashboard tile and route added.
  Evidence: Git commits; TestFlight build pending
2026-01-31 — [F-106] Parking Finder feature
  Result: Created ParkingFinderScreen with FlutterMap showing 10 Milwaukee parking locations. Color-coded markers (Blue=Garage, Green=Lot, Yellow=Street). Tap for details with Google Maps directions integration.
  Evidence: Git commits; TestFlight build pending
2026-01-31 — [F-105] User onboarding flow
  Result: Implemented 5-page onboarding flow (Welcome, Avoid Tickets, Alt-Side, Notifications, Create Account). Uses OnboardingService with SharedPreferences. Integrated into main.dart routing.
  Evidence: Git commits; TestFlight build pending
2026-01-31 — [F-405] Garbage Day feature fix
  Result: Fixed URL case sensitivity bug. Milwaukee DPW API changed from `DPWServletsPublic` to `DpwServletsPublic` causing HTTP 302 redirects. Updated GarbageScheduleService URL.
  Evidence: Git commits; verified API response
2026-01-31 — [F-203] EV charging map integration
  Result: Simplified and optimized for mobile. Collapsible filter panel, FlutterMap with OpenChargeMap, connector type filters, color-coded markers by power level, tap-to-expand details.
  Evidence: Git commits; TestFlight build pending
2026-01-31 — [F-102] Smart notifications (complete)
  Result: Added sendHighRiskAlerts Cloud Function for citation-based risk zone alerts. Integrated with parking risk heatmap system.
  Evidence: Cloud Functions deployment; Git commits
2026-01-31 — [F-101] Heatmap + pattern analytics
  Result: Processed 466K Milwaukee parking citations into 44 geohash risk zones (Firestore citation_risk_zones). Created Cloud Functions (getRiskForLocation, getRiskZones, sendHighRiskAlerts). Built ParkingRiskService, ParkingRiskBadge, FlutterMap heatmap with color-coded risk levels.
  Evidence: Firestore collection; Cloud Functions deployment; Git commits
2026-01-18 — [F-102] Smart notifications (partial)
  Result: Push notification infrastructure completed (FCM tokens, APNs forwarding, sendNearbyAlerts callable); emulator testing with rate limits/audit logs; ready for production activation.
  Evidence: Emulator logs + callable tests
2026-01-17/18 — [F-008] Moderation basics
  Result: Report button increments reports field; sightings with 4+ reports excluded from feed; per-anonymous UID rate limiting; verified locally with controlled abuse tests.
  Evidence: Local tests
2026-01-16 — [F-404] iOS TestFlight readiness checklist (backend + config)
  Result: Production build uploaded; internal TestFlight enabled; full core loop verified on real iOS devices (submit → appear → expire → disappear).
  Evidence: App Store Connect + device verification
2026-01-15/16 — [F-007] Expiration system for “live sightings”
  Result: cleanupExpiredSightings scheduler active; sightings auto-expire and disappear from live feed; verified with Dretzka Park test doc.
  Evidence: Firestore status=expired + scheduler logs
2026-01-15/16 — [F-003] Confirm app-to-backend connectivity (permanent)
  Result: Anonymous auth enabled; submissions create sightings and alerts with mirroring; verified via iOS simulator, curl, and function logs.
  Evidence: Firestore docs + Cloud Functions logs
2026-01-15/16 — [F-404] iOS TestFlight readiness checklist (backend + config)
  Result: Release build uploaded to App Store Connect; internal TestFlight testing enabled and functioning; iOS build confirmed production-ready.
  Evidence: App Store Connect upload + TestFlight internal testing
2026-01-15 — [F-007] Expiration system for “live sightings”
  Result: Automated lifecycle confirmed; test doc flipped to status="expired"; cleanupExpiredSightings runs on schedule; no manual intervention required.
  Evidence: Firestore doc update to status=expired; scheduler runs in logs
2026-01-15 — [F-003] Confirm app-to-backend connectivity (permanent)
  Result: End-to-end app→backend→Firestore→mirror chain verified; app creates sightings, functions mirror to alerts/global; anonymous auth and rate limits verified; no crashes or silent failures.
  Evidence: Firestore docs created + submitSighting invocation; logs clean
2026-01-14 — [F-003] Confirm app-to-backend connectivity
  Result: End-to-end write succeeded via iOS simulator submission (temp open rules enabled creation in sightings; mirroring worked). Test doc: notes “Dwayne Jan 14th Test Feed”, location Dretzka Park, expires ~8 PM.
  Evidence: iOS simulator test doc in Firestore
2026-01-14 — [F-002] Inventory Cloud Functions (prod) and confirm deploy is clean
  Result: Full visibility into prod functions (mkeparkapp-1ad15). Six v2 functions (cleanupExpiredSightings, helloWorld, mirrorSightingsToAlerts, mirrorUserSightingsToGlobal, notifyOnApproval, submitSighting). All us-central1/nodejs20/256MiB; audit/runtime logs clean; cleanupExpiredSightings runs ~every 5 min with 200s; submitSighting has no invocations yet.
  Evidence: gcloud functions describe --gen2; gcloud logging read (cloud_run_revision, severity>=ERROR)
2026-01-11 — [F-005] Sightings: create + store reliably (end-to-end)
  Result: Verified that sightings can be created and persist correctly in Firestore. Manually tested documents to prove feed invisibility is caused by path/schema mismatch. Established that the data layer is sound when written to correct collections.
  Evidence: Manual Firestore validation
2026-01-10 — [F-001] Verify Firebase project + environment configuration
  Result: Confirmed MKE City Smart is using the correct Firebase project (Blaze plan). Ruled out environment mismatch as cause of missing alerts/sightings. Removed “wrong project” as a failure vector in backend debugging.
  Evidence: Firebase Console verification
2026-01-11 — [F-004] Finalize Firestore schema used by the app (source of truth)
  Result: Defined and validated the production Firestore schema. Locked core collections (sightings, live_sightings, alerts) and required fields. Confirmed that writing to incorrect paths explains “missing” feed data. Schema is now the single source of truth for app + backend.
  Evidence: Manual Firestore validation
2026-01-14 — [F-401] Security rules audit (update)
  Result: Updated alerts rules for public reads + admin deletes; added firestore.indexes.json reference; deployed rules + indexes.
  Evidence: firebase deploy --only firestore (prod)
2026-01-11 — [F-401] Security rules audit
  Result: Added firestore target to firebase.json, created firestore.rules, fixed compilation error, deployed Firestore rules to prod.
  Evidence: firebase deploy --only firestore:rules (prod)
2026-01-11 — [F-001] Verify Firebase project + environment configuration
  Result: Confirmed app Firebase config points to mkeparkapp-1ad15 (iOS + Android). Firebase CLI using prod alias.
  Evidence: Config review; firebase alias prod -> mkeparkapp-1ad15
-- YYYY-MM-DD — [F-XXX] Title
  Result: (1–2 lines describing what changed / verified)
  Evidence: (link to commit/PR, screenshot ref, command output, TestFlight build #, etc.)
